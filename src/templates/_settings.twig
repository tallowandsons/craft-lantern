{# @var plugin \tallowandsons\lantern\Lantern #}
{# @var settings \tallowandsons\lantern\models\Settings #}

{% import '_includes/forms.twig' as forms %}
{% from 'lantern/macros' import configWarning %}

<div class="field">
    {{ forms.lightswitchField({
        id: 'enabled',
        name: 'enabled',
        on: settings.enabled,
        label: 'Enable Lantern',
        instructions: 'Master switch. When disabled, Lantern will not replace the Twig loader or perform template tracking.',
        warning: (config.enabled is defined ? configWarning('enabled')),
    }) }}
</div>

<hr>

<h2>Template Statuses</h2>

<div class="field">
    {{ forms.textField({
        id: 'staleDays',
        name: 'staleDays',
        label: 'Stale after (days)',
        value: settings.staleDays,
        size: 4,
        type: 'number',
        min: 1,
        instructions: 'Number of days after which a template is considered stale.',
        warning: (config.staleDays is defined ? configWarning('staleDays') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'newTemplateDays',
        name: 'newTemplateDays',
        label: 'New template period (days)',
        instructions: 'Number of days after which a newly discovered template is no longer considered "new".',
        value: settings.newTemplateDays ?? 90,
        size: 4,
        type: 'number',
        min: 1,
        warning: (config.newTemplateDays is defined ? configWarning('newTemplateDays') : null)
    }) }}
</div>

<hr>

<h2>Autoâ€‘Flush</h2>

<p>Template logs are initially stored in the data cache and must be flushed to the database to be persisted.<br>
This can be done manually via a cronjob or automatically during a web request.<br>
</p>

<div class="field">
    {{ forms.lightswitchField({
        id: 'autoFlushEnabled',
        name: 'autoFlushEnabled',
        on: settings.autoFlushEnabled,
        label: 'Enable auto-flush to database',
        instructions: 'Queues a background job to persist cache to database, without blocking web requests.',
        warning: (config.autoFlushEnabled is defined ? configWarning('autoFlushEnabled') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'autoFlushIntervalSeconds',
        name: 'autoFlushIntervalSeconds',
        value: settings.autoFlushIntervalSeconds,
        size: 6,
        type: 'number',
        min: 60,
        label: 'Scan interval (seconds)',
        instructions: 'Minimum time between auto-flushes. Defaults to 5 minutes (300 seconds).',
        warning: (config.autoFlushIntervalSeconds is defined ? configWarning('autoFlushIntervalSeconds') : null)
    }) }}
</div>


<div class="field">
    {{ forms.lightswitchField({
        id: 'autoFlushOnlyOnCpRequests',
        name: 'autoFlushOnlyOnCpRequests',
        on: settings.autoFlushOnlyOnCpRequests,
        label: 'Only queue from Control Panel requests',
        instructions: 'If enabled, frontend requests will not queue a flush.',
        warning: (config.autoFlushOnlyOnCpRequests is defined ? configWarning('autoFlushOnlyOnCpRequests') : null)
    }) }}
</div>

<hr>

<h2>Auto Template Scans</h2>

<p>Lanterns needs to periodically scan the templates directory so that it has an up-to-date record of templates.<br>
This can be done manually via a cronjob or automatically during a web request.
</p>

<div class="field">
    {{ forms.lightswitchField({
        id: 'autoScanTemplatesEnabled',
        name: 'autoScanTemplatesEnabled',
        on: settings.autoScanTemplatesEnabled,
        label: 'Enable automatic template scans',
        instructions: 'Scan the templates directory in the background.',
        warning: (config.autoScanTemplatesEnabled is defined ? configWarning('autoScanTemplatesEnabled') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'autoScanIntervalSeconds',
        name: 'autoScanIntervalSeconds',
        value: settings.autoScanIntervalSeconds,
        size: 6,
        type: 'number',
        min: 600,
        label: 'Scan interval (seconds)',
        instructions: 'Minimum time between automatic scans. Defaults to once per day (86400 seconds).',
        warning: (config.autoScanIntervalSeconds is defined ? configWarning('autoScanIntervalSeconds') : null)
    }) }}
</div>

<hr>

<h2>Legacy Template Fallback</h2>

<p>To help you tidy up unused templates, you can enable a legacy directory.<br>
This allows you to move legacy templates into a separate folder without deleting them.<br>
When a template is not found in the standard locations, Lantern will look for it in the specified legacy directory.<br>
</p>

<div class="field">
    {{ forms.lightswitchField({
        id: 'enableLegacyTemplates',
        name: 'enableLegacyTemplates',
        on: settings.enableLegacyTemplates,
        label: 'Enable Legacy Template Fallback',
        instructions: 'When enabled, templates will fallback to a legacy directory if not found in the standard locations.',
        warning: (config.enableLegacyTemplates is defined ? configWarning('enableLegacyTemplates') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'legacyTemplatesDir',
        name: 'legacyTemplatesDir',
        value: settings.legacyTemplatesDir,
        label: 'Legacy Templates Directory Name',
        instructions: 'Name for legacy template directory. Templates will be resolved from `@templates/<legacy-directory>/...`',
        placeholder: '_legacy',
        warning: (config.legacyTemplatesDir is defined ? configWarning('legacyTemplatesDir') : null)
    }) }}
</div>

<hr>

<h2>Aggregation &amp; Retention</h2>

<div class="field">
    <div class="heading"><label for="dailyRetentionDays">Keep daily data (days)</label></div>
    {{ forms.textField({
        id: 'dailyRetentionDays',
        name: 'dailyRetentionDays',
        value: settings.dailyRetentionDays,
        size: 4,
        type: 'number',
        min: 0,
        warning: (config.dailyRetentionDays is defined ? configWarning('dailyRetentionDays') : null)
    }) }}
    <p class="light">Keep recent daily rows for high-resolution charts (0 = disable daily pruning).</p>
    <p class="light">Monthly aggregation always processes completed months only.</p>
    <p class="light">Tip: 90 days is a good default.</p>

    <div class="heading" style="margin-top: 1rem;"><label for="monthlyRetentionMonths">Keep monthly data (months)</label></div>
    {{ forms.textField({
        id: 'monthlyRetentionMonths',
        name: 'monthlyRetentionMonths',
        value: settings.monthlyRetentionMonths,
        size: 4,
        type: 'number',
        min: 0,
        warning: (config.monthlyRetentionMonths is defined ? configWarning('monthlyRetentionMonths') : null)
    }) }}
    <p class="light">Keep long-term monthly rows for trend analysis (0 = keep all months).</p>

    <div class="heading" style="margin-top: 1rem;"><label for="prune">Prune after aggregation</label></div>
    {{ forms.lightswitchField({
        id: 'prune',
        name: 'prune',
        on: settings.prune,
        onLabel: 'Enabled',
        offLabel: 'Disabled',
        warning: (config.prune is defined ? configWarning('prune') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'aggregateIntervalSeconds',
        name: 'aggregateIntervalSeconds',
        value: settings.aggregateIntervalSeconds,
        size: 6,
        type: 'number',
        min: 600,
        label: 'Aggregation interval (seconds)',
        instructions: 'Minimum time between monthly aggregation runs. Default 12 hours (43200).',
        warning: (config.aggregateIntervalSeconds is defined ? configWarning('aggregateIntervalSeconds') : null)
    }) }}
</div>
