{# @var plugin \tallowandsons\lantern\Lantern #}
{# @var settings \tallowandsons\lantern\models\Settings #}

{% import '_includes/forms.twig' as forms %}
{% from 'lantern/macros' import configWarning %}

<div class="field">
    {{ forms.lightswitchField({
        id: 'enabled',
        name: 'enabled',
        on: settings.enabled,
        label: 'Enable Lantern',
        instructions: 'Master switch. When disabled, Lantern will not replace the Twig loader or perform template tracking.',
        warning: (config.enabled is defined ? configWarning('enabled')),
    }) }}
</div>

<div class="field">
    <div class="heading"><label for="staleDays">Stale after (days)</label></div>
    {{ forms.textField({
        id: 'staleDays',
        name: 'staleDays',
        value: settings.staleDays,
        size: 4,
        type: 'number',
        min: 1,
        warning: (config.staleDays is defined ? configWarning('staleDays') : null)
    }) }}
</div>

<div class="field">
    <div class="heading"><label for="newTemplateDays">New template window (days)</label></div>
    {{ forms.textField({
        id: 'newTemplateDays',
        name: 'newTemplateDays',
        value: settings.newTemplateDays ?? 90,
        size: 4,
        type: 'number',
        min: 1,
        warning: (config.newTemplateDays is defined ? configWarning('newTemplateDays') : null)
    }) }}
</div>

<hr>

<h3>Aggregation &amp; Retention</h3>

<div class="field">
    <div class="heading"><label for="dailyRetentionDays">Keep daily data (days)</label></div>
    {{ forms.textField({
        id: 'dailyRetentionDays',
        name: 'dailyRetentionDays',
        value: settings.dailyRetentionDays,
        size: 4,
        type: 'number',
        min: 0,
        warning: (config.dailyRetentionDays is defined ? configWarning('dailyRetentionDays') : null)
    }) }}
    <p class="light">Keep recent daily rows for high-resolution charts (0 = disable daily pruning).</p>
    <p class="light">Monthly aggregation always processes completed months only.</p>
    <p class="light">Tip: 90 days is a good default.</p>

    <div class="heading" style="margin-top: 1rem;"><label for="monthlyRetentionMonths">Keep monthly data (months)</label></div>
    {{ forms.textField({
        id: 'monthlyRetentionMonths',
        name: 'monthlyRetentionMonths',
        value: settings.monthlyRetentionMonths,
        size: 4,
        type: 'number',
        min: 0,
        warning: (config.monthlyRetentionMonths is defined ? configWarning('monthlyRetentionMonths') : null)
    }) }}
    <p class="light">Keep long-term monthly rows for trend analysis (0 = keep all months).</p>

    <div class="heading" style="margin-top: 1rem;"><label for="prune">Prune after aggregation</label></div>
    {{ forms.lightswitchField({
        id: 'prune',
        name: 'prune',
        on: settings.prune,
        onLabel: 'Enabled',
        offLabel: 'Disabled',
        warning: (config.prune is defined ? configWarning('prune') : null)
    }) }}
</div>

<hr>

<h3>Legacy Template Fallback</h3>

<div class="field">
    {{ forms.lightswitchField({
        id: 'enableLegacyTemplates',
        name: 'enableLegacyTemplates',
        on: settings.enableLegacyTemplates,
        label: 'Enable Legacy Template Fallback',
        instructions: 'When enabled, templates will fallback to a legacy directory if not found in the standard locations.',
        warning: (config.enableLegacyTemplates is defined ? configWarning('enableLegacyTemplates') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'legacyTemplatesDir',
        name: 'legacyTemplatesDir',
        value: settings.legacyTemplatesDir,
        label: 'Legacy Templates Directory Name',
        instructions: 'Directory name for legacy template fallback (e.g., "_legacy"). Templates will be resolved from `templates/<legacy-directory>/...`',
        placeholder: '_legacy',
        warning: (config.legacyTemplatesDir is defined ? configWarning('legacyTemplatesDir') : null)
    }) }}
</div>

<hr>

<h3>Autoâ€‘Flush (background)</h3>

<div class="field">
    {{ forms.lightswitchField({
        id: 'autoFlushEnabled',
        name: 'autoFlushEnabled',
        on: settings.autoFlushEnabled,
        label: 'Enable auto-flush to database',
        instructions: 'Queues a background job to persist cache to DB, without blocking web requests.',
        warning: (config.autoFlushEnabled is defined ? configWarning('autoFlushEnabled') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'autoFlushIntervalSeconds',
        name: 'autoFlushIntervalSeconds',
        value: settings.autoFlushIntervalSeconds,
        size: 6,
        type: 'number',
        min: 60,
        label: 'Minimum interval (seconds)',
        instructions: 'Debounce time between background flushes (minimum 60s).',
        warning: (config.autoFlushIntervalSeconds is defined ? configWarning('autoFlushIntervalSeconds') : null)
    }) }}
</div>


<div class="field">
    {{ forms.lightswitchField({
        id: 'autoFlushOnlyOnCpRequests',
        name: 'autoFlushOnlyOnCpRequests',
        on: settings.autoFlushOnlyOnCpRequests,
        label: 'Only queue from Control Panel requests',
        instructions: 'If enabled, frontend requests will not queue a flush.',
        warning: (config.autoFlushOnlyOnCpRequests is defined ? configWarning('autoFlushOnlyOnCpRequests') : null)
    }) }}
</div>

<h3>Auto Template Scans</h3>

<div class="field">
    {{ forms.lightswitchField({
        id: 'autoScanTemplatesEnabled',
        name: 'autoScanTemplatesEnabled',
        on: settings.autoScanTemplatesEnabled,
        label: 'Enable automatic template scans',
        instructions: 'Scan the templates directory in the background to discover new templates without needing a cron.',
        warning: (config.autoScanTemplatesEnabled is defined ? configWarning('autoScanTemplatesEnabled') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'autoScanIntervalSeconds',
        name: 'autoScanIntervalSeconds',
        value: settings.autoScanIntervalSeconds,
        size: 6,
        type: 'number',
        min: 600,
        label: 'Scan interval (seconds)',
        instructions: 'Minimum time between automatic scans. Defaults to once per day (86400 seconds).',
        warning: (config.autoScanIntervalSeconds is defined ? configWarning('autoScanIntervalSeconds') : null)
    }) }}
</div>

<div class="field">
    {{ forms.textField({
        id: 'aggregateIntervalSeconds',
        name: 'aggregateIntervalSeconds',
        value: settings.aggregateIntervalSeconds,
        size: 6,
        type: 'number',
        min: 600,
        label: 'Aggregation interval (seconds)',
        instructions: 'Minimum time between monthly aggregation runs. Default 12 hours (43200).',
        warning: (config.aggregateIntervalSeconds is defined ? configWarning('aggregateIntervalSeconds') : null)
    }) }}
</div>
